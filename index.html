<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación Facial - Versión Depurada</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* ... (mantén los mismos estilos) ... */
        .debug {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- ... (mantén el mismo HTML) ... -->
    <div id="debugInfo" class="debug"></div>
    
    <script>
        // Variables globales con estado más claro
        const state = {
            modelsLoaded: false,
            videoReady: false,
            capturedDescriptor: null,
            credentialDescriptor: null
        };
        
        // Elementos del DOM
        const elements = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            credentialImg: document.getElementById('credentialImg'),
            result: document.getElementById('result'),
            debugInfo: document.getElementById('debugInfo')
        };
        
        // Función para actualizar información de depuración
        function updateDebugInfo() {
            elements.debugInfo.innerHTML = `
                <strong>Estado del sistema:</strong><br>
                - Modelos cargados: ${state.modelsLoaded ? '✅' : '❌'}<br>
                - Video listo: ${state.videoReady ? '✅' : '❌'}<br>
                - Rostro capturado: ${state.capturedDescriptor ? '✅' : '❌'}<br>
                - Credencial procesada: ${state.credentialDescriptor ? '✅' : '❌'}
            `;
        }
        
        // Cargar modelos con verificación mejorada
        async function loadModels() {
            try {
                console.log("Cargando modelos...");
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                state.modelsLoaded = true;
                console.log("Modelos cargados correctamente");
                updateDebugInfo();
                return true;
            } catch (error) {
                console.error("Error al cargar modelos:", error);
                elements.result.textContent = "Error al cargar los modelos de reconocimiento facial";
                elements.result.className = "no-match";
                return false;
            }
        }
        
        // Iniciar cámara con mejor manejo de errores
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: "user" 
                    } 
                });
                elements.video.srcObject = stream;
                
                // Esperar a que el video esté realmente listo
                await new Promise((resolve) => {
                    elements.video.onloadedmetadata = () => {
                        state.videoReady = true;
                        updateDebugInfo();
                        resolve();
                    };
                });
                
                return true;
            } catch (err) {
                console.error("Error al acceder a la cámara:", err);
                elements.result.textContent = "Error al acceder a la cámara: " + err.message;
                elements.result.className = "no-match";
                return false;
            }
        }
        
        // Capturar rostro con verificación mejorada
        async function captureFace() {
            if (!state.modelsLoaded || !state.videoReady) {
                elements.result.textContent = "Los modelos o la cámara no están listos";
                elements.result.className = "no-match";
                return;
            }
            
            try {
                console.log("Intentando detectar rostro...");
                const detections = await faceapi.detectAllFaces(
                    elements.video, 
                    new faceapi.TinyFaceDetectorOptions({ inputSize: 320 })
                ).withFaceLandmarks().withFaceDescriptors();
                
                console.log("Detecciones encontradas:", detections.length);
                
                if (detections.length === 0) {
                    elements.result.textContent = "No se detectó ningún rostro. Asegúrate de estar bien iluminado y frente a la cámara.";
                    elements.result.className = "no-match";
                    return;
                }
                
                // Dibujar detección
                const displaySize = { width: elements.video.width, height: elements.video.height };
                faceapi.matchDimensions(elements.canvas, displaySize);
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                faceapi.draw.drawDetections(elements.canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(elements.canvas, resizedDetections);
                
                // Almacenar descriptor
                state.capturedDescriptor = detections[0].descriptor;
                elements.result.textContent = "Rostro capturado correctamente!";
                elements.result.className = "match";
                updateDebugInfo();
                
                console.log("Descriptor facial capturado:", state.capturedDescriptor);
            } catch (error) {
                console.error("Error en captureFace:", error);
                elements.result.textContent = "Error al capturar el rostro: " + error.message;
                elements.result.className = "no-match";
            }
        }
        
        // Procesar imagen de credencial mejorado
        async function processCredentialImage(file) {
            if (!state.modelsLoaded) {
                elements.result.textContent = "Los modelos no están cargados todavía";
                elements.result.className = "no-match";
                return;
            }
            
            try {
                elements.credentialImg.src = URL.createObjectURL(file);
                
                // Esperar a que la imagen se cargue completamente
                await new Promise((resolve, reject) => {
                    elements.credentialImg.onload = resolve;
                    elements.credentialImg.onerror = reject;
                });
                
                console.log("Procesando imagen de credencial...");
                const detections = await faceapi.detectAllFaces(
                    elements.credentialImg, 
                    new faceapi.TinyFaceDetectorOptions({ inputSize: 320 })
                ).withFaceLandmarks().withFaceDescriptors();
                
                console.log("Detecciones en credencial:", detections.length);
                
                if (detections.length === 0) {
                    elements.result.textContent = "No se encontró un rostro en la imagen de credencial. Usa una foto más clara.";
                    elements.result.className = "no-match";
                    return;
                }
                
                state.credentialDescriptor = detections[0].descriptor;
                elements.result.textContent = "Credencial procesada correctamente!";
                elements.result.className = "match";
                updateDebugInfo();
                
                console.log("Descriptor de credencial:", state.credentialDescriptor);
            } catch (error) {
                console.error("Error en processCredentialImage:", error);
                elements.result.textContent = "Error al procesar la credencial: " + error.message;
                elements.result.className = "no-match";
            }
        }
        
        // Comparar rostros con más información
        async function compareFaces() {
            console.log("Comparando rostros... Estado actual:", state);
            
            if (!state.capturedDescriptor || !state.credentialDescriptor) {
                let message = "Faltan: ";
                if (!state.capturedDescriptor) message += "rostro capturado, ";
                if (!state.credentialDescriptor) message += "imagen de credencial";
                
                elements.result.textContent = "Por favor completa ambos pasos: " + message;
                elements.result.className = "no-match";
                return;
            }
            
            try {
                const distance = faceapi.euclideanDistance(state.capturedDescriptor, state.credentialDescriptor);
                const threshold = 0.6;
                const similarity = Math.round((1 - distance) * 100);
                
                console.log(`Distancia: ${distance.toFixed(4)}, Similitud: ${similarity}%`);
                
                if (distance < threshold) {
                    elements.result.textContent = `¡Coincidencia! Similitud del ${similarity}%`;
                    elements.result.className = "match";
                } else {
                    elements.result.textContent = `No coincide (Similitud: ${similarity}%). Por favor, intenta nuevamente.`;
                    elements.result.className = "no-match";
                }
            } catch (error) {
                console.error("Error en compareFaces:", error);
                elements.result.textContent = "Error al comparar rostros: " + error.message;
                elements.result.className = "no-match";
            }
        }
        
        // Inicialización mejorada
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Inicializando aplicación...");
            
            // Cargar modelos primero
            const modelsLoaded = await loadModels();
            if (!modelsLoaded) return;
            
            // Iniciar video
            const videoStarted = await startVideo();
            if (!videoStarted) return;
            
            // Configurar event listeners
            document.getElementById('captureBtn').addEventListener('click', captureFace);
            document.getElementById('compareBtn').addEventListener('click', compareFaces);
            
            document.getElementById('credentialInput').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    processCredentialImage(e.target.files[0]);
                }
            });
            
            console.log("Aplicación inicializada correctamente");
            updateDebugInfo();
        });
    </script>
</body>
</html>
